---
processors:
  - append:
      field: tags
      value: "pipeline_administrative_and_operational_audit applied"
  - set:
      field: event.kind
      value: event
  - gsub:
      field: message
      pattern: ", , "
      replacement: ", "
      ignore_missing: true
      ignore_failure: true      
  - grok:
      field: message
      if: ctx?.cisco_ise?.log?.segment?.number == 0
      patterns: 
       #- "^%{TIMESTAMP_ISO8601:_tmp.timestamp} %{ISO8601_TIMEZONE:event.timezone} %{DATA:event.sequence:long} %{DATA:cisco_ise.log.message.code} %{DATA:log.syslog.severity.name} %{DATA:cisco_ise.log.message.description}, %{GREEDYDATA:cisco_ise.log.log_details},"
        - "^%{TIMESTAMP_ISO8601:_tmp.timestamp} %{ISO8601_TIMEZONE:event.timezone} %{NUMBER:event.sequence:long} %{NOTSPACE:log.syslog.severity.name} %{NUMBER:cisco_ise.log.message.code} %{DATA:cisco_ise.log.message.description}, %{GREEDYDATA:cisco_ise.log.log_details},"  
        - "^%{TIMESTAMP_ISO8601:_tmp.timestamp} %{ISO8601_TIMEZONE:event.timezone} %{NUMBER:event.sequence:long} %{NUMBER:cisco_ise.log.message.code} %{NOTSPACE:log.syslog.severity.name} %{DATA:cisco_ise.log.message.description}, %{GREEDYDATA:cisco_ise.log.log_details},"  
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - grok:
      field: message
      if: ctx?.cisco_ise?.log?.segment?.number > 0
      patterns: 
        - "^%{GREEDYDATA:cisco_ise.log.log_details},"
      on_failure:
        - append:
            field: error.message
            value: '{{{_ingest.on_failure_message}}}'
  - grok:
      field: cisco_ise.log.log_details
      if: ctx?.cisco_ise?.log?.message?.code == "60067"
      ignore_failure: true
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, OperationMessageText={%{DATA:cisco_ise.log.log_details_object.OperationMessageText}}"
  - grok:
      field: cisco_ise.log.log_details
      if: '["61025", "61026"].contains(ctx?.cisco_ise?.log?.message?.code)'
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, AdminInterface=%{DATA:cisco_ise.log.log_details_object.AdminInterface}, AdminIPAddress=%{DATA:cisco_ise.log.log_details_object.AdminIPAddress}, OperationMessageText=%{DATA:cisco_ise.log.log_details_object.OperationMessageText}, AcsInstance=%{GREEDYDATA:cisco_ise.log.log_details_object.AcsInstance}"
      on_failure:
        - kv:
            field: cisco_ise.log.log_details
            target_field: cisco_ise.log.log_details_object
            field_split: ', '
            value_split: =
            trim_key: " "
  - grok:
      field: cisco_ise.log.log_details
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, FailureFlag=%{DATA:cisco_ise.log.log_details_object.FailureFlag}, RequestResponseType=%{DATA:cisco_ise.log.log_details_object.RequestResponseType}, AdminInterface=%{DATA:cisco_ise.log.log_details_object.AdminInterface}, AdminIPAddress=%{DATA:cisco_ise.log.log_details_object.AdminIPAddress}, AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, %{GREEDYDATA:tmp.log_detail_52001}"
  - grok:
      field: tmp.log_detail_52001
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
      patterns: 
        - "ConfigChangeData=%{DATA:cisco_ise.log.log_details_object.ConfigChangeData}, ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{DATA:cisco_ise.log.log_details_object.ObjectName}, Component=%{DATA:cisco_ise.log.log_details_object.Component}, ObjectInternalID=%{GREEDYDATA:cisco_ise.log.log_details_object.ObjectInternalID}"
        - "ConfigChangeData=%{DATA:cisco_ise.log.log_details_object.ConfigChangeData}, ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{DATA:cisco_ise.log.log_details_object.ObjectName}, OperationMessageText=%{GREEDYDATA:cisco_ise.log.log_details_object.OperationMessageText}"
        - "ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{DATA:cisco_ise.log.log_details_object.ObjectName}, Component=%{DATA:cisco_ise.log.log_details_object.Component}, ObjectInternalID=%{GREEDYDATA:cisco_ise.log.log_details_object.ObjectInternalID}"
        - "ConfigChangeData=%{DATA:cisco_ise.log.log_details_object.ConfigChangeData}, ObjectType=%{DATA:cisco_ise.log.log_details_object.ObjectType}, ObjectName=%{GREEDYDATA:cisco_ise.log.log_details_object.ObjectName}"
  - grok:
      field: tmp.log_detail_52001.ConfigChangeData
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
      patterns: 
        - "^%{DATA:_tmp.temp}, Log Severity Level = %{DATA:cisco_ise.log.log_details_object.LogSeverityLevel}\\\\,Local Logging = %{DATA:cisco_ise.log.log_details_object.LocalLogging}\\\\,Assigned Targets = {%{DATA:cisco_ise.log.log_details_object.AssignedTargets}}"
  - grok:
      field: cisco_ise.log.log_details
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      ignore_failure: true
      patterns: 
        - "ConfigVersionId=%{DATA:cisco_ise.log.log_details_object.ConfigVersionId}, AdminInterface=%{DATA:cisco_ise.log.log_details_object.AdminInterface}, AdminIPAddress=%{DATA:cisco_ise.log.log_details_object.AdminIPAddress}, %{GREEDYDATA:tmp.log_detail_52002}"
  - grok:
      field: tmp.log_detail_52002
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      ignore_failure: true
      patterns: 
        - "AdminSession=%{DATA:cisco_ise.log.log_details_object.AdminSession}, AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, ConfigChangeData=%{GREEDYDATA:cisco_ise.log.log_details_object.ConfigChangeData}"
        - "AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, ConfigChangeData=%{GREEDYDATA:cisco_ise.log.log_details_object.ConfigChangeData}"
        - "AdminName=%{DATA:cisco_ise.log.log_details_object.AdminName}, %{GREEDYDATA:cisco_ise.log.log_details_object.log_description}"
      on_failure:
        - kv:
            field: cisco_ise.log.log_details
            target_field: cisco_ise.log.log_details_object
            field_split: ', '
            value_split: =
            trim_key: " "
  - kv:
      field: cisco_ise.log.log_details_object.log_description
      target_field: cisco_ise.log.log_details_object
      field_split: ', '
      trim_key: " "
      value_split: =
      ignore_failure: true
  - grok:
      field: cisco_ise.log.log_details_object.ConfigChangeData
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      ignore_failure: true
      patterns: 
        - "^%{DATA:_tmp.temp}, %{GREEDYDATA:_tmp.ConfigChangeData}"
  - kv:
      field: _tmp.ConfigChangeData
      target_field: cisco_ise.log.log_details_object
      if: ctx?.cisco_ise?.log?.message?.code == "52002"
      field_split: ', '
      value_split: =
      trim_key: " "
      ignore_failure: true
  - kv: 
      if: '!["60067", "61025", "61026", "52001", "52002"].contains(ctx.cisco_ise.log.message.code)'
      field: cisco_ise.log.log_details
      target_field: cisco_ise.log.log_details_object
      field_split: ', '
      value_split: =
      trim_key: " "
      ignore_failure: true
  - kv: 
      if: ctx?.cisco_ise?.log?.message?.code == "60067"
      field: cisco_ise.log.log_details_object.OperationMessageText
      target_field: cisco_ise.log.log_details_object
      field_split: ', '
      value_split: =
      trim_key: " "
      ignore_failure: true
  - split: 
      field: cisco_ise.log.log_details_object.AssignedTargets
      target_field: cisco_ise.log.assigned_targets
      separator: ','
      if: ctx?.cisco_ise?.log?.message?.code == "52001"
      ignore_failure: true
  - date:
      field: _tmp.timestamp
      target_field: '@timestamp'
      formats: 
        - yyyy-MM-dd HH:mm:ss.SSS
        - yyyy-MM-dd HH:mm:ss.SSSSSS
      timezone: '{{{event.timezone}}}'
      ignore_failure: true
  - script:
      lang: painless
      if: ctx?.cisco_ise?.log?.message?.code != null
      source: |
        def eventCategory = new ArrayList();
        def eventType = new ArrayList();
        def categoryReferenceTable = [
          ["messageCodeArray": ["51001","51002","51020","51021","52000","52001","52002","60077","60078","60461","61077","60077","58005","60094","60093","60134","60188","60116","60080","60115","60081"], "name": "iam"],
          ["messageCodeArray": ["51001","51002","51020","51021","60077","60078","61077", "60077","60188","60116","60080","60115","60081"], "name": "authentication"],
          ["messageCodeArray": ["61025","61026","60134"], "name": "network"],
          ["messageCodeArray": ["60067","60070","60456","58005"], "name": "process"],
          ["messageCodeArray": ["52000","52001","52002"], "name": "configuration"]
        ];
        def typeReferenceTable = [
          ["messageCodeArray": ["51001","51002","51020","51021"], "name": "admin"],
          ["messageCodeArray": ["52001"], "name": "change"],
          ["messageCodeArray": ["61025", "61026"], "name": "connection"],
          ["messageCodeArray": ["52000"], "name": "creation"],
          ["messageCodeArray": ["52002"], "name": "deletion"],
          ["messageCodeArray": ["61026"], "name": "end"],
          ["messageCodeArray": ["60116","60080","60115","60081"], "name": "user"],
          ["messageCodeArray": ["51001","51002","51020","51021","52000","52001","52002","60067","60070","60077","60078","60456","60461","61025","61026","61077","60077","58005","60094","60093","60134","60188","60116","60080","60115","60081"], "name": "info"],
          ["messageCodeArray": ["60067","60456","61025"], "name": "start"]
        ];

        for (entry in categoryReferenceTable) {
          if (entry.messageCodeArray.contains(ctx.cisco_ise.log.message.code)) {
            eventCategory.add(entry.name);
          }
        }
        for (entry in typeReferenceTable) {
          if (entry.messageCodeArray.contains(ctx.cisco_ise.log.message.code)) {
            eventType.add(entry.name);
          }
        }

        ctx.event.action = ctx?.cisco_ise?.log?.message?.description?.splitOnToken(":")[0]?.toLowerCase();
        ctx.event.category = eventCategory;
        ctx.event.type = eventType;
      ignore_failure: true
